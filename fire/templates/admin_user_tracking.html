<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Tracking - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .tracking-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .tracking-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border: none;
        }
        
        .card-body {
            padding: 30px;
        }
        
        .stats-row {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .user-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        .user-info {
            flex: 1;
            margin-left: 20px;
        }
        
        .user-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .user-details {
            color: #6c757d;
            font-size: 14px;
        }
        
        .user-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .user-stat {
            text-align: center;
        }
        
        .user-stat-number {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }
        
        .user-stat-label {
            font-size: 12px;
            color: #6c757d;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .role-admin {
            background: #dc3545;
            color: white;
        }
        
        .role-manager {
            background: #fd7e14;
            color: white;
        }
        
        .role-inspector {
            background: #20c997;
            color: white;
        }
        
        .role-user {
            background: #6c757d;
            color: white;
        }
        
        .activity-timeline {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .activity-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 10px;
        }
        
        .activity-text {
            flex: 1;
            color: #333;
        }
        
        .activity-time {
            color: #6c757d;
            font-size: 11px;
        }
        
        .back-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
            text-decoration: none;
        }
        
        .search-filters {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            padding: 8px 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: #667eea;
            border-color: #667eea;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="tracking-container">
        <a href="{{ url_for('admin_dashboard') }}" class="back-button">
            <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
        </a>
        
        <!-- Statistics -->
        <div class="tracking-card">
            <div class="card-header">
                <h3><i class="fas fa-users me-2"></i> User Statistics</h3>
            </div>
            <div class="card-body">
                <div class="stats-row">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="totalUsers">-</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="activeUsers">-</div>
                                <div class="stat-label">Active Today</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="newUsers">-</div>
                                <div class="stat-label">New This Month</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="onlineUsers">-</div>
                                <div class="stat-label">Currently Online</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Search and Filters -->
        <div class="tracking-card">
            <div class="card-header">
                <h3><i class="fas fa-search me-2"></i> Search & Filters</h3>
            </div>
            <div class="card-body">
                <div class="search-filters">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Search Users</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by name, email, or username...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="roleFilter">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="inspector">Inspector</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Sort By</label>
                            <select class="form-select" id="sortBy">
                                <option value="name">Name</option>
                                <option value="created_at">Registration Date</option>
                                <option value="last_login">Last Login</option>
                                <option value="application_count">Applications</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User List -->
        <div class="tracking-card">
            <div class="card-header">
                <h3><i class="fas fa-list me-2"></i> User Tracking</h3>
            </div>
            <div class="card-body">
                <div id="usersList">
                    <!-- Users will be loaded here -->
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        <span id="userCount">Showing 0 users</span>
                    </div>
                    <nav>
                        <ul class="pagination mb-0" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        let usersPerPage = 10;
        
        // Load user tracking data
        async function loadUserTracking() {
            try {
                const response = await fetch('/api/admin/user-tracking');
                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.data.users;
                    filteredUsers = [...allUsers];
                    
                    // Update statistics
                    updateStatistics();
                    
                    // Display users
                    displayUsers();
                }
            } catch (error) {
                console.error('Error loading user tracking data:', error);
            }
        }
        
        // Update statistics
        function updateStatistics() {
            const today = new Date().toDateString();
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const activeToday = allUsers.filter(user => {
                const lastLogin = user.last_login;
                return lastLogin && new Date(lastLogin).toDateString() === today;
            });
            
            const newThisMonth = allUsers.filter(user => {
                const created = new Date(user.created_at);
                return created.getMonth() === thisMonth && created.getFullYear() === thisYear;
            });
            
            // Simulate online users (in a real app, this would be tracked)
            const onlineUsers = Math.floor(allUsers.length * 0.1); // 10% assumed online
            
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('activeUsers').textContent = activeToday.length;
            document.getElementById('newUsers').textContent = newThisMonth.length;
            document.getElementById('onlineUsers').textContent = onlineUsers;
        }
        
        // Display users
        function displayUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);
            
            usersToShow.forEach(user => {
                const userCard = createUserCard(user);
                usersList.appendChild(userCard);
            });
            
            // Update pagination
            updatePagination();
            
            // Update count
            document.getElementById('userCount').textContent = 
                `Showing ${startIndex + 1}-${Math.min(endIndex, filteredUsers.length)} of ${filteredUsers.length} users`;
        }
        
        // Create user card
        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';
            
            const lastLogin = user.last_login !== 'Never' ? 
                new Date(user.last_login).toLocaleDateString() : 'Never';
            
            const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 
                            user.username.substring(0, 2).toUpperCase();
            
            card.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="user-avatar">
                        ${initials}
                    </div>
                    <div class="user-info">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="user-name">${user.name || user.username}</div>
                                <div class="user-details">
                                    <i class="fas fa-envelope me-1"></i> ${user.email}
                                    <span class="ms-3"><i class="fas fa-phone me-1"></i> ${user.phone || 'Not provided'}</span>
                                </div>
                                <div class="user-details mt-1">
                                    <i class="fas fa-user me-1"></i> @${user.username}
                                    <span class="ms-3"><i class="fas fa-calendar me-1"></i> Joined: ${new Date(user.created_at).toLocaleDateString()}</span>
                                    <span class="ms-3"><i class="fas fa-clock me-1"></i> Last login: ${lastLogin}</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="role-badge role-${user.role}">${user.role}</span>
                                <div class="mt-2">
                                    <span class="status-badge status-${user.status}">${user.status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-number">${user.application_count || 0}</div>
                                <div class="user-stat-label">Applications</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-number">${user.recent_activities || 0}</div>
                                <div class="user-stat-label">Recent Activities</div>
                            </div>
                        </div>
                        
                        <div class="user-actions">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewUserDetails('${user._id}')">
                                <i class="fas fa-eye me-1"></i> View Details
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewUserActivities('${user.username}')">
                                <i class="fas fa-history me-1"></i> Activities
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="sendMessage('${user.username}')">
                                <i class="fas fa-envelope me-1"></i> Message
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            filteredUsers = allUsers.filter(user => {
                // Search filter
                if (searchTerm && 
                    !user.name.toLowerCase().includes(searchTerm) &&
                    !user.email.toLowerCase().includes(searchTerm) &&
                    !user.username.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Role filter
                if (roleFilter && user.role !== roleFilter) {
                    return false;
                }
                
                // Status filter
                if (statusFilter && user.status !== statusFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Sort users
            filteredUsers.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return (a.name || a.username).localeCompare(b.name || b.username);
                    case 'created_at':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'last_login':
                        const aLogin = a.last_login === 'Never' ? new Date(0) : new Date(a.last_login);
                        const bLogin = b.last_login === 'Never' ? new Date(0) : new Date(b.last_login);
                        return bLogin - aLogin;
                    case 'application_count':
                        return (b.application_count || 0) - (a.application_count || 0);
                    default:
                        return 0;
                }
            });
            
            currentPage = 1;
            displayUsers();
        }
        
        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }
        
        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayUsers();
            }
        }
        
        // User action functions
        function viewUserDetails(userId) {
            window.open(`/admin/user/${userId}`, '_blank');
        }
        
        function viewUserActivities(username) {
            window.open(`/admin/user-activities?user=${username}`, '_blank');
        }
        
        function sendMessage(username) {
            const message = prompt(`Send message to ${username}:`);
            if (message) {
                showNotification(`Message sent to ${username}`, 'success');
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Real-time search
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        });
        
        // Load data on page load
        loadUserTracking();
        
        // Auto-refresh every 60 seconds
        setInterval(loadUserTracking, 60000);
    </script>
</body>
</html>
